<!DOCTYPE html>
<html ng-app='dxmanager' lang="en">
  <head>
    <title>DXManager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="/css/style.css" rel="stylesheet" media="screen">
  </head>
  <body>
    <div class="container">
      <div ng-controller="EnvironmentCtrl">
        <div class='pull-right'>
          <form ng-init="load_auth()" ng-switch="auth" class="form-inline" role="form">

            <span ng-switch-when="false">
              <div class='form-group'>
                <input type="text" class="form-control" ng-model="login_form.username" placeholder="Username">
              </div>
              <div class='form-group'>
                <input type="password" class="form-control" ng-model="login_form.api_token" placeholder="Jenkins API Token">
              </div>
              <button type='submit' class='btn btn-default' ng-click="log_in()">Log In</button>
            </span>

            <span ng-switch-default>
              Logged in as {{ auth.username }}
              <button ng-click="log_out()"class='btn btn-default'>Log Out</button>
            </span>

            <button class='btn btn-default' ng-class="{'loading': active_requests > 0}" ng-click="update_data()" title='{{ active_requests }} active requests'>Refresh</button>

          </form>
        </div>
        <h1>DXManager - AWS</h1>

        <div ng-init="refresh(); tab='environments'">

          <div ng-class="{hide: errors.length < 1}">
              <div ng-repeat="error in errors" class="alert alert-danger" role="alert"><span class='glyphicon glyphicon-warning-sign'></span>&nbsp;&nbsp;Error: {{ error }}</div>
          </div>

          <div>

            <div class='row'>
              <div class='col-md-12 filter-list'>
                Filter
                <a ng-click="filter_exclusively=!filter_exclusively" href='#'>{{ filter_exclusively ? "exclusively" : "all of" }}</a>
                <button ng-repeat="filter in filters | orderBy: ['key', 'value']" ng-click="enable_filter(filter)" ng-class="{'btn-primary': filter.enabled}" type="button" class="btn btn-default btn-xs">
                  <span class="glyphicon glyphicon-tag"></span> {{ filter.key }}: {{ filter.value }} ({{ filter.count }})
                </button>
              </div>
            </div>

            <div ng-repeat="env in environments | filter : filter_environments" class='row env'>
              <div class='col-md-4'>
               <h3>{{ env.tags.name }}</h3>
                <div class="progress">
                  <div class="progress-bar" role="progressbar" aria-valuenow="{{ env.current_size }}" aria-valuemin="0" aria-valuemax="{{ env.max_size }}" style="width: {{ env.current_size * 100 / env.max_size }}%;">
                    {{ env.current_size }} instance - {{ env.min_size }} min / {{ env.desired_size }} desired / {{ env.max_size }} max
                  </div>
                </div>
                Environment: {{ env.tags.environment }}
                <div ng-switch="env.tags.build_user">
                  <div ng-switch-when="None Specified">No Deploy Information</div>
                  <div ng-switch-default>{{ env.tags.build_user }} ran <a target='_blank' href='{{ env.tags.build_url }}'>{{ env.tags.build_url.replace("http://jenkins.devaws.dataxu.net/job/", '') }}</a></div>
                </div>
                AWS: <a target='_blank' href='https://console.aws.amazon.com/ec2/autoscaling/home?region=us-east-1#AutoScalingGroups:id={{ env.name }}'>AutoScaling Group</a> - <a target='_blank' href='https://console.aws.amazon.com/ec2/autoscaling/home?region=us-east-1#LaunchConfigurations:id={{ env.launch_config_name }}'>Launch Configuration</a>
              </div>
              <div class='col-md-8'>
                <h3>{{ env.ami_id }} ({{ env.ami_tags.node_type }})</h3>
                GitHub: <a target='_blank' href='{{ env.ami_tags.git_url | remote2github }}'>{{ env.ami_tags.git_url | remote2name }}</a> - 
                <a target='_blank' href='{{ env.ami_tags.git_url | remote2github }}/tree/{{ env.ami_tags.git_commit }}'>[{{ env.ami_tags.git_branch.replace('origin/', '') }}] {{ env.ami_tags.git_commit | short_hash }}</a>
                <br/>AMI: <a target='_blank' href='{{ env.ami_tags.build_url }}'>{{ env.ami_tags.build_url.replace("http://jenkins.devaws.dataxu.net/job/", '') }}</a>
                <br/><p>{{ env.ami_description }}</p>

                <div class="form-inline" role="form">
                  <div class='form-group'>
                    <button class="btn btn-default" type="button" ng-click="env.show_amis = !env.show_amis">Show AMIs</button>
                  </div>
                  <div class='form-group'>
                    <div class="input-group deploy-input-group">
                      <input ng-model="env.deploy_ami" type="text" class="form-control" placeholder="{{ env.ami_id }}">
                      <span class="input-group-btn">
                        <button ng-click="deploy(env, env.deploy_ami)" class="btn btn-default" type="button">Deploy</button>
                      </span>
                    </div>
                  </div>
                </div>

                <div ng-hide="!env.show_amis">
                  <p>List of AMIs with node_type, {{ env.ami_tags.node_type }}, like the currently . Clicking a row will populate the deploy field.</p>
                  <table class="table table-hover table-condensed">
                      <thead>
                          <tr>
                            <th class='col-md-1'>ID</th>
                            <th class='col-md-1'>Name</th>
                            <th class='col-md-1'>Git</th>
                          </tr>
                      </thead>
                      <tr ng-repeat="ami in env.ami_candidates | orderBy: '-name'" ng-click="env.deploy_ami = ami.id">
                          <td><a target='_blank' href='https://console.aws.amazon.com/ec2/v2/home?region=us-east-1#Images:filter=all-images;search={{ ami.id }}'>{{ ami.id }}</td>
                          <td><a target='_blank' href='{{ ami.tags.build_url }}'>{{ ami.name }}</a></td>
                          <td><a target='_blank' href='{{ ami.tags.git_url | remote2github }}/tree/{{ ami.tags.git_commit }}'>{{ ami.tags.git_branch.replace('origin/', '') }} {{ ami.tags.git_commit | short_hash }}</a></td>
                      </tr>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <!-- <pre>{{ get_data() }}</pre> -->
          <a href='#' class='pull-right' ng-click='show_help=!show_help'>Help</a>
          <p>Created by <a target='_blank' href='http://github.com/ferrants/'>Matt Ferrante</a> for <a target='_blank' href='http://github.com/dataxu/'>DataXu</a></p>
          <div ng-hide="!show_help">
            <h3>Help</h3>
            <p>Information about how to use</p>
          </div>
          <h3>Todo:</h3>
          <ul>
            <li>Pull jenkins information to show</li>
            <li>Actual Deploy</li>
            <li>Disable deploy</li>
            <li>Warnings on misconfiguration</li>
          </ul>
        </div>
      </div>
    </div>

    <script src="/lib/jquery/dist/jquery.min.js"></script>
    <script src="/lib/momentjs/moment.js"></script>
    <script src="/lib/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="/lib/angular/angular.min.js"></script>
    <script src="/lib/angular-local-storage/angular-local-storage.min.js"></script>
    <script src="/js/app.js"></script>
  </body>
</html>
